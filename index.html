<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Merge Gift Game</title>
<style>
    body {
        font-family: Arial, sans-serif;
        background-color: #001a00;
        color: #ffcc00;
        margin: 0;
        padding: 20px;
        text-align: center;
    }
    h1 { color: #ff69b4; text-shadow: 0 0 10px #ff1493; }
    .container {
        max-width: 600px;
        margin: 0 auto;
        background: #002200;
        border-radius: 20px;
        padding: 20px;
        box-shadow: 0 0 20px rgba(255,204,0,0.3);
    }
    #level-info { font-size: 20px; margin: 10px 0; }
    #progress-bar { background: #003300; height: 25px; border-radius: 15px; overflow: hidden; margin: 10px 0; }
    #progress { background: linear-gradient(to right, #ffcc00, #ff69b4); height: 100%; width: 0%; transition: width 0.5s; }
    #energy-info { font-size: 18px; margin: 15px 0; }
    #gift-count { font-size: 18px; margin: 10px 0; color: #ff69b4; }
    #game-board {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 8px;
        justify-content: center;
        margin: 20px auto;
        max-width: 400px;
    }
    .cell {
        width: 70px;
        height: 70px;
        background: #001100;
        border-radius: 12px;
        border: 2px solid #003300;
        position: relative;
        overflow: hidden;
    }
    .cell.locked {
        background: #000800;
        border-color: #001100;
        opacity: 0.5;
        pointer-events: none;
    }
    .item {
        width: 100%;
        height: 100%;
        object-fit: contain;
        position: absolute;
        top: 0;
        left: 0;
        draggable: true;
    }
    button {
        background: #ff69b4;
        color: white;
        border: none;
        padding: 12px 25px;
        font-size: 18px;
        border-radius: 15px;
        cursor: pointer;
        margin: 10px;
        box-shadow: 0 5px 15px rgba(255,105,180,0.4);
    }
    button:hover { background: #ff1493; transform: scale(1.05); }
    button:disabled { background: #666; cursor: not-allowed; opacity: 0.6; }

    .modal {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.9); display: none; align-items: center; justify-content: center; z-index: 100;
    }
    .modal-content {
        background: #002200; 
        padding: 25px; 
        border-radius: 20px; 
        width: 90%; 
        max-width: 550px;
        max-height: 85vh;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
    }
    .modal-buttons {
        display: flex;
        justify-content: center;
        margin-top: 20px;
    }
    .modal-buttons-left {
        justify-content: flex-start;
    }

    /* Гифт-набор */
    #reel-container {
        position: relative;
        width: 460px;
        height: 160px;
        margin: 40px auto;
        background: #001100;
        border-radius: 15px;
        overflow: hidden;
        border: 6px solid #ffcc00;
        box-shadow: 0 0 40px rgba(255,204,0,0.6);
    }
    #reel-wrapper { width: 100%; height: 100%; overflow: hidden; position: relative; }
    #reel { display: flex; position: absolute; left: 0; top: 0; }
    .reel-item {
        width: 150px;
        height: 160px;
        flex-shrink: 0;
        object-fit: contain;
        background: radial-gradient(circle at center, #004400 0%, #001100 100%);
        border-right: 3px solid #002200;
        box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
    }
    #pointer-line {
        position: absolute; top: 0; left: 50%; width: 6px; height: 100%;
        background: linear-gradient(to bottom, transparent, #ffcc00 50%, transparent);
        box-shadow: 0 0 20px #ffcc00; z-index: 10; transform: translateX(-50%);
    }
    #pointer-arrow {
        position: absolute; top: -25px; left: 50%; transform: translateX(-50%);
        font-size: 50px; color: #ffcc00; text-shadow: 0 0 15px #ff69b4; z-index: 11;
    }

    .reward-list { text-align: left; margin: 20px 0; flex-grow: 1; }
    .reward-item { padding: 12px; background: #001100; border-radius: 10px; margin: 8px 0; }
    .current-level { background: #ff69b4 !important; color: white; font-weight: bold; }
    .past-level { opacity: 0.7; }

    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin: 20px 0; }
    .cal-day { padding: 12px; background: #001100; border-radius: 10px; }
    .cal-today { background: #ff69b4 !important; color: white; cursor: pointer; }
    .cal-past { opacity: 0.4; }
    .cal-future { opacity: 0.3; }
    .cal-claimed { background: #004400; }
</style>
</head>
<body>

<div class="container">
    <h1>Merge Gift Game</h1>
    <div id="level-info">Уровень: 1 | Опыт: 0 / 100</div>
    <div id="progress-bar"><div id="progress"></div></div>
    <div id="energy-info">Энергия: 20 / 20</div>
    <div id="gift-count">Гифт-наборы: 0</div>

    <div id="game-board"></div>

    <button id="spawn-button">Спавн предмета (5 энергии)</button>
    <button id="gift-sets-button" disabled>Гифт-наборы</button>
    <button id="rewards-preview-button">Награды уровней</button>
    <button id="calendar-button">Календарь</button>
</div>

<!-- Гифт-набор -->
<div id="gift-modal" class="modal">
    <div class="modal-content">
        <h2 style="color:#ffcc00;">Открываем гифт-набор!</h2>
        <div id="reel-container">
            <div id="pointer-arrow">▼</div>
            <div id="pointer-line"></div>
            <div id="reel-wrapper">
                <div id="reel"></div>
            </div>
        </div>
        <div id="win-result" style="font-size:26px; margin:30px; color:#ffcc00; min-height:60px;"></div>
        <div class="modal-buttons">
            <button id="close-gift">Закрыть</button>
        </div>
    </div>
</div>

<!-- Награды уровней -->
<div id="rewards-modal" class="modal">
    <div class="modal-content">
        <h2>Награды уровней</h2>
        <div class="reward-list" id="rewards-list"></div>
        <div class="modal-buttons modal-buttons-left">
            <button id="back-rewards">◄ Назад</button>
        </div>
    </div>
</div>

<!-- Календарь -->
<div id="calendar-modal" class="modal">
    <div class="modal-content">
        <h2 id="cal-month">Январь 2026</h2>
        <div class="calendar-grid" id="cal-grid"></div>
        <div class="modal-buttons">
            <button id="close-calendar">Закрыть</button>
        </div>
    </div>
</div>

<script>
const ITEM_IMAGES = [
    "https://media.istockphoto.com/id/1459635542/vector/teddy-bear-icon-set-editable-stroke.jpg?s=612x612&w=0&k=20&c=EMOWhqZMl1FPV7tWtgnjKgBv7EeWG9hNM9bKkJjfji8=",
    "https://static.vecteezy.com/system/resources/previews/003/267/981/non_2x/heart-symbol-mascot-cartoon-giving-the-gift-free-vector.jpg",
    "https://i.fbcd.co/products/resized/resized-750-500/one006e-41-e02-mainpreview-f4969a39a7b3114fee9f9b17477f8533455df64ad814b124b5b3a89b70af6591.jpg",
    "https://t4.ftcdn.net/jpg/17/07/36/25/360_F_1707362523_EC8jYsnKr44mrhn5mpgxtQjtnQ65FAO1.jpg",
    "https://i.fbcd.co/products/resized/resized-750-500/naj20-10-1575cff896488af51ed0eed8f2ad8a19c5c77ff7093f715ef8de9e0a5ea345e0.jpg",
    "https://static.vecteezy.com/system/resources/previews/054/666/494/non_2x/dynamic-cartoon-rocket-icon-with-vibrant-colors-depicting-launch-innovation-and-space-exploration-in-a-playful-modern-style-free-vector.jpg",
    "https://i.fbcd.co/products/resized/resized-750-500/g16223-95a8fcc5f46afb49a63cd4d1c7e17b1d926c7c2865634787ffaf5cd361f55cac.jpg",
    "https://img.freepik.com/premium-vector/cartoon-trophy-cup-icon-vector-illustration-success-achievement_1138841-26011.jpg",
    "https://media.istockphoto.com/id/1268794152/vector/diamond-vector-isolated-collection-vector-gem-jewel-symbol-signs-cartoon-diamonds-icon.jpg?s=612x612&w=0&k=20&c=NC6J8KqJvuC8PS47Qk3Yw_xTSV2krWQMJaKJa-CJ-4g=",
    "https://cbx-prod.b-cdn.net/COLOURBOX63317673.jpg?width=800&height=800&quality=70",
    "https://thumbs.dreamstime.com/b/game-victory-icon-badge-award-trophy-gui-banner-interface-rewards-screen-featuring-golden-star-raised-spears-red-ribbons-wings-355252594.jpg"
];

const SPAWN_CHANCES = [0.70, 0.20, 0.07, 0.02, 0.005, 0.002, 0.001, 0.0005, 0.0003, 0.0001, 0.0001];
const SPAWN_EXP = [5, 10, 20, 40, 80, 160, 320, 640, 1280, 2560, 5120];

const GRID_SIZE = 25;
const ENERGY_COST = 5;
const MAX_ENERGY_BASE = 20;
const ENERGY_REGEN_MS = 120000; // 2 минуты

let level = 1;
let exp = 0;
let expToNext = 100;
let maxEnergy = MAX_ENERGY_BASE;
let energy = maxEnergy;
let giftSetsCount = 0;
let board = Array(GRID_SIZE).fill(null);
let dragSrc = null;
let todayClaimed = false;
let lastRegenTime = Date.now(); // Время последнего регена

const TODAY = new Date();

// === LocalStorage ===
function saveGame() {
    const saveData = {
        level, exp, expToNext, maxEnergy, energy, giftSetsCount, board, todayClaimed,
        lastSaveDate: TODAY.toDateString()
    };
    localStorage.setItem('mergeGiftSave', JSON.stringify(saveData));
}

function loadGame() {
    const saved = localStorage.getItem('mergeGiftSave');
    if (!saved) return false;

    const data = JSON.parse(saved);
    level = data.level || 1;
    exp = data.exp || 0;
    expToNext = data.expToNext || 100;
    maxEnergy = data.maxEnergy || MAX_ENERGY_BASE;
    energy = data.energy || maxEnergy;
    giftSetsCount = data.giftSetsCount || 0;
    board = data.board || Array(GRID_SIZE).fill(null);
    todayClaimed = data.todayClaimed || false;

    if (data.lastSaveDate !== TODAY.toDateString()) {
        todayClaimed = false;
    }

    return true;
}

function autoSave() {
    saveGame();
    updateLevel();
    updateEnergy();
    updateGiftCount();
    renderBoard();
    updateBoardVisibility();
}

// === Доска ===
const gameBoard = document.getElementById('game-board');
for (let i = 0; i < GRID_SIZE; i++) {
    const cell = document.createElement('div');
    cell.classList.add('cell');
    cell.dataset.index = i;
    cell.addEventListener('dragover', e => e.preventDefault());
    cell.addEventListener('drop', handleDrop);
    gameBoard.appendChild(cell);
}

function updateBoardVisibility() {
    document.querySelectorAll('.cell').forEach((cell, i) => {
        if (i >= 20 && level < 50) {
            cell.classList.add('locked');
        } else {
            cell.classList.remove('locked');
        }
    });
}

function updateLevel() {
    document.getElementById('level-info').textContent = `Уровень: ${level} | Опыт: ${exp} / ${expToNext}`;
    document.getElementById('progress').style.width = `${(exp / expToNext) * 100}%`;
}

function updateEnergy() {
    document.getElementById('energy-info').textContent = `Энергия: ${energy} / ${maxEnergy}`;
}

function updateGiftCount() {
    document.getElementById('gift-count').textContent = `Гифт-наборы: ${giftSetsCount}`;
    document.getElementById('gift-sets-button').disabled = giftSetsCount <= 0;
}

// Реген энергии ТОЛЬКО во время активной сессии (не восстанавливается при перезаходе)
setInterval(() => {
    const now = Date.now();
    if (now - lastRegenTime >= ENERGY_REGEN_MS && energy < maxEnergy) {
        energy++;
        lastRegenTime = now;
        autoSave();
    }
}, 5000); // Проверяем каждые 5 секунд

// Сохраняем при выходе
window.addEventListener('beforeunload', saveGame);

// Спавн предмета
document.getElementById('spawn-button').addEventListener('click', () => {
    if (energy < ENERGY_COST) return alert('Недостаточно энергии!');
    const empty = board.map((v, i) => (v === null && (i < 20 || level >= 50)) ? i : null).filter(v => v !== null);
    if (empty.length === 0) return alert('Нет свободного места!');

    energy -= ENERGY_COST;

    let rand = Math.random();
    let cum = 0;
    let lvl = 0;
    for (let i = 0; i < SPAWN_CHANCES.length; i++) {
        cum += SPAWN_CHANCES[i];
        if (rand <= cum) { lvl = i; break; }
    }

    const idx = empty[Math.floor(Math.random() * empty.length)];
    board[idx] = lvl;

    addExp(SPAWN_EXP[lvl]);
    autoSave();
});

// Drag & Drop
function handleDragStart(e) {
    if (!e.target.classList.contains('item')) return;
    dragSrc = parseInt(e.target.parentNode.dataset.index);
}

function handleDrop(e) {
    e.preventDefault();
    const targetIdx = parseInt(e.target.dataset.index || e.target.parentNode.dataset.index);
    if (dragSrc === null || dragSrc === targetIdx) return;

    if (targetIdx >= 20 && level < 50) return;

    const srcLvl = board[dragSrc];
    const tgtLvl = board[targetIdx];

    if (srcLvl !== null && tgtLvl !== null && srcLvl === tgtLvl) {
        let newLvl = srcLvl + 1;
        if (newLvl > 10) newLvl = 10;
        board[targetIdx] = newLvl;
        board[dragSrc] = null;

        let gainedExp = 10 * (srcLvl + 1);
        if (srcLvl === 9) gainedExp = 100;
        if (srcLvl === 10) {
            gainedExp = Math.floor(200 * (2 + Math.random()));
            board[targetIdx] = null;
            board[dragSrc] = null;
        }
        addExp(gainedExp);
    } else if (tgtLvl === null) {
        board[targetIdx] = srcLvl;
        board[dragSrc] = null;
    }
    autoSave();
}

function renderBoard() {
    document.querySelectorAll('.cell').forEach((cell, i) => {
        cell.innerHTML = '';
        if (board[i] !== null) {
            const img = document.createElement('img');
            img.src = ITEM_IMAGES[board[i]];
            img.classList.add('item');
            img.draggable = true;
            img.addEventListener('dragstart', handleDragStart);
            cell.appendChild(img);
        }
    });
}

function addExp(amount) {
    exp += amount;
    while (exp >= expToNext) {
        exp -= expToNext;
        level++;
        expToNext = Math.floor(100 * level * 1.2);

        if (level % 10 === 0) alert(`Уровень ${level}! Разблокирована новая картинка!`);
        if (level % 25 === 0) {
            maxEnergy += 5;
            energy = Math.min(energy + 5, maxEnergy);
            updateEnergy();
            alert(`Уровень ${level}! +5 к максимуму энергии!`);
        }
        if (level === 50) {
            alert(`Уровень 50! Открыт нижний ряд ячеек (21-25)!`);
            updateBoardVisibility();
        }
        giftSetsCount += 1;
        updateGiftCount();
        alert(`Получен гифт-набор!`);
    }
    autoSave();
}

// Гифт-наборы
document.getElementById('gift-sets-button').addEventListener('click', () => {
    if (giftSetsCount > 0) {
        giftSetsCount--;
        updateGiftCount();
        openGiftSet();
        autoSave();
    }
});

function openGiftSet() {
    document.getElementById('gift-modal').style.display = 'flex';
    const reel = document.getElementById('reel');
    reel.innerHTML = '';
    document.getElementById('win-result').textContent = 'Крутится...';

    const totalItems = 60;
    const itemWidth = 150;
    const containerWidth = 460;
    const centerOffset = containerWidth / 2 - itemWidth / 2;

    const items = [];
    for (let i = 0; i < totalItems; i++) {
        const lvl = weightedRandomLevel();
        const img = document.createElement('img');
        img.src = ITEM_IMAGES[lvl];
        img.classList.add('reel-item');
        reel.appendChild(img);
        items.push(lvl);
    }

    const winIndex = 25 + Math.floor(Math.random() * 10);
    const winLevel = items[winIndex];
    const finalX = -(winIndex * itemWidth) + centerOffset;

    reel.style.transition = 'none';
    reel.style.transform = `translateX(0px)`;
    requestAnimationFrame(() => {
        reel.style.transition = 'transform 5.5s cubic-bezier(0.08, 0.82, 0.17, 1)';
        reel.style.transform = `translateX(${finalX}px)`;
    });

    setTimeout(() => {
        const expGained = SPAWN_EXP[winLevel];
        document.getElementById('win-result').innerHTML = `
            <strong style="font-size:32px;">ПОЗДРАВЛЯЕМ!</strong><br><br>
            Вы выиграли: <strong>Уровень ${winLevel + 1}</strong><br>
            +${expGained} опыта
        `;
        addExp(expGained);

        const empty = board.findIndex(c => c === null && (c < 20 || level >= 50));
        if (empty !== -1) {
            board[empty] = winLevel;
            renderBoard();
        }
        autoSave();
    }, 5800);
}

function weightedRandomLevel() {
    let rand = Math.random();
    let cum = 0;
    for (let i = 0; i < SPAWN_CHANCES.length; i++) {
        cum += SPAWN_CHANCES[i];
        if (rand <= cum) return i;
    }
    return 0;
}

document.getElementById('close-gift').addEventListener('click', () => {
    document.getElementById('gift-modal').style.display = 'none';
});

// Награды уровней
document.getElementById('rewards-preview-button').addEventListener('click', () => {
    document.getElementById('rewards-modal').style.display = 'flex';
    const list = document.getElementById('rewards-list');
    list.innerHTML = '';

    const pastStart = Math.max(1, level - 10);
    const futureEnd = level + 20;

    for (let l = pastStart; l <= futureEnd; l++) {
        const div = document.createElement('div');
        div.classList.add('reward-item');
        if (l < level) div.classList.add('past-level');
        if (l === level) div.classList.add('current-level');

        let text = `Уровень ${l}: `;
        if (l % 10 === 0) text += 'Новая картинка | ';
        if (l % 25 === 0) text += '+5 энергии | ';
        if (l === 50) text += 'Открытие нижнего ряда | ';
        text += 'Гифт-набор';

        div.textContent = text;
        list.appendChild(div);
    }
});

document.getElementById('back-rewards').addEventListener('click', () => {
    document.getElementById('rewards-modal').style.display = 'none';
});

// Календарь
document.getElementById('calendar-button').addEventListener('click', showCalendar);
document.getElementById('close-calendar').addEventListener('click', () => {
    document.getElementById('calendar-modal').style.display = 'none';
});

function showCalendar() {
    const modal = document.getElementById('calendar-modal');
    const grid = document.getElementById('cal-grid');
    grid.innerHTML = '';

    const year = TODAY.getFullYear();
    const month = TODAY.getMonth();
    const todayDate = TODAY.getDate();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const firstDay = new Date(year, month, 1).getDay() || 7;

    ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'].forEach(day => {
        const h = document.createElement('div');
        h.textContent = day;
        h.style.fontWeight = 'bold';
        h.style.color = '#ffcc00';
        grid.appendChild(h);
    });

    for (let i = 1; i < firstDay; i++) grid.appendChild(document.createElement('div'));

    for (let day = 1; day <= daysInMonth; day++) {
        const cell = document.createElement('div');
        cell.classList.add('cal-day');
        cell.textContent = day;

        if (day < todayDate) cell.classList.add('cal-past');
        if (day > todayDate) cell.classList.add('cal-future');
        if (day === todayDate) {
            cell.classList.add('cal-today');
            if (todayClaimed) {
                cell.classList.add('cal-claimed');
                cell.textContent += ' ✓';
            } else {
                cell.addEventListener('click', () => {
                    todayClaimed = true;
                    giftSetsCount += 1;
                    updateGiftCount();
                    addExp(100);
                    alert('Награда дня: Гифт-набор + 100 опыта!');
                    cell.classList.add('cal-claimed');
                    cell.textContent += ' ✓';
                    autoSave();
                });
            }
        }
        grid.appendChild(cell);
    }

    modal.style.display = 'flex';
}

// === Загрузка и старт ===
if (loadGame()) {
    console.log('Прогресс загружен');
} else {
    console.log('Новая игра');
}

updateLevel();
updateEnergy();
updateGiftCount();
renderBoard();
updateBoardVisibility();
lastRegenTime = Date.now(); // Начинаем отсчёт регена с текущего момента
</script>
</body>
</html>
